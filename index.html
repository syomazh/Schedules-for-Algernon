<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ðŸ–±</title>
        <!-- Tailwind CSS CDN -->
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            /* Custom styles for dark mode and soft colors */
            :root {
                --bg-color: #f0f4f8; /* Light background for overall body */
                --main-text-color: #1a202c; /* Near-black for main titles and body text in light mode */
                --panel-heading-color: #1a202c; /* Explicitly dark for panel headings */
                --label-color: #4a5568; /* Slightly softer dark for labels in light mode */
                --secondary-text-color: #718096; /* Darker grey for secondary text in light mode */
                --border-color: #e2e8f0; /* Light gray border */
                --header-bg-color: #cbd5e1; /* Medium gray for day headers */
                --period-time-bg: #e2e8f0; /* Background for time column */
                --period-time-text: #475569; /* Text for time column */
                --overlay-bg: rgba(0, 0, 0, 0.5); /* Semi-transparent overlay for modal */
                --modal-bg: #ffffff; /* White modal background */

                /* Variables for panel styling */
                --panel-bg: #ffffff; /* Light background for control panels */
                --panel-item-bg: #f8fafc; /* Lighter background for list items/section groups */
                --input-bg: #ffffff; /* White background for inputs */
                --input-text: #1a202c; /* Dark text for inputs in light mode */
                --input-border: #d1d5db; /* Light border for inputs */
            }

            .dark {
                --bg-color: #1e293b; /* Dark slate background */
                --main-text-color: #f8fafc; /* Lightest text in dark mode */
                --panel-heading-color: #f8fafc; /* Explicitly light for panel headings */
                --label-color: #cbd5e1; /* Lighter grey for labels in dark mode */
                --secondary-text-color: #a0aec0; /* Lighter grey for secondary text in dark mode */
                --border-color: #334155; /* Darker border */
                --header-bg-color: #33415e; /* Darker gray for headers */
                --period-time-bg: #475569;
                --period-time-text: #e2e8f0;
                --overlay-bg: rgba(0, 0, 0, 0.7); /* Darker overlay */
                --modal-bg: #334155; /* Dark modal background */

                /* Dark mode variables for panel styling */
                --panel-bg: #1f2937; /* Darker background for control panels */
                --panel-item-bg: #374151; /* Even darker for list items/section groups */
                --input-bg: #334155;
                --input-text: #f8fafc;
                --input-border: #4b5563;
            }

            body {
                background-color: var(--bg-color);
                color: var(--main-text-color); /* General body text color */
                font-family: "Inter", sans-serif;
                transition: background-color 0.3s, color 0.3s;
            }

            /* Main page title */
            .page-title {
                color: var(--main-text-color);
            }

            .calendar-grid {
                display: grid;
                grid-template-columns: 80px repeat(5, 1fr); /* Time column + 5 days */
                grid-template-rows: auto minmax(0, 1fr); /* Header row + content row */
                border: 1px solid var(--border-color);
                border-radius: 0.75rem; /* rounded-xl */
                overflow: hidden;
                background-color: var(--bg-color);
            }

            .day-header, .time-slot, .period-block, .event-slot, .current-time-line {
                border-color: var(--border-color);
            }

            .day-header:first-child {
                border-right: 1px solid var(--border-color); /* Ensure the corner header has a right border */
            }

            .day-header {
                background-color: var(--header-bg-color);
                color: var(--main-text-color); /* Changed from --text-color to --main-text-color */
                font-weight: 600; /* semibold */
                padding: 0.75rem 0.5rem; /* py-3 px-2 */
                text-align: center;
                border-bottom: 1px solid var(--border-color);
                border-right: 1px solid var(--border-color);
            }

            .day-header:last-child {
                border-right: none;
            }

            .time-column {
                grid-column: 1;
                grid-row: 2;
                padding-top: 0.5rem;
                background-color: var(--period-time-bg);
                color: var(--period-time-text);
                font-size: 0.875rem; /* text-sm */
                font-weight: 500; /* medium */
                text-align: right;
                border-right: 1px solid var(--border-color);
                display: flex;
                flex-direction: column;
                position: relative;
            }
            .time-label {
                position: absolute;
                width: 100%;
                padding-right: 0.5rem;
                transform: translateY(-50%); /* Adjust to center vertically on the line */
            }


            .schedule-content {
                grid-column: 2 / span 5;
                grid-row: 2;
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                position: relative; /* For absolute positioning of events */
            }

            .day-column {
                position: relative;
                border-right: 1px solid var(--border-color);
                height: 100%; /* Ensure day column takes full height of the schedule content */
            }
            .day-column:last-child {
                border-right: none;
            }

            .period-block {
                position: absolute;
                left: 0;
                width: 100%;
                box-sizing: border-box;
                background-color: rgba(255, 255, 255, 0.05); /* Very subtle overlay */
                border-bottom: 1px dashed var(--border-color); /* Soft period divider */
                padding: 0.25rem;
                color: var(--main-text-color); /* Changed from --text-color to --main-text-color */
                font-size: 0.75rem; /* text-xs */
                overflow: hidden;
                z-index: 1; /* Ensure periods are behind events */
            }

            .event-slot {
                position: absolute;
                left: 0;
                box-sizing: border-box;
                width: 100%;
                padding: 0.25rem 0.5rem;
                border-radius: 0.5rem; /* rounded-lg */
                font-size: 0.875rem; /* text-sm */
                font-weight: 500; /* medium */
                color: white; /* Event text color */
                overflow: hidden;
                cursor: pointer;
                z-index: 10; /* Ensure events are on top */
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            .current-time-line {
                position: absolute;
                /* Adjust left/right to span the correct columns within schedule-content */
                height: 2px;
                background-color: #ef4444; /* red-500 */
                z-index: 20;
                pointer-events: none; /* Allow clicks to pass through */
            }

            /* Modal styles */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background-color: var(--overlay-bg);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }

            .modal-content {
                background-color: var(--modal-bg);
                padding: 2rem;
                border-radius: 0.75rem; /* rounded-xl */
                box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
                max-width: 500px;
                width: 90%;
                color: var(--main-text-color); /* Modal content text */
            }

            /* Color classes for events - using Tailwind's default colors with opacity */
            .bg-custom-blue { background-color: #60a5fa; } /* blue-400 */
            .bg-custom-green { background-color: #4ade80; } /* green-400 */
            .bg-custom-purple { background-color: #a78bfa; } /* violet-400 */
            .bg-custom-yellow { background-color: #fbbf24; } /* amber-400 */
            .bg-custom-pink { background-color: #f472b6; } /* pink-400 */
            .bg-custom-teal { background-color: #2dd4bf; } /* teal-400 */
            .bg-custom-orange { background-color: #fb923c; } /* orange-400 */
            .bg-custom-red-500 { background-color: #ef4444; } /* red-500 */

            /* New CSS for greyed-out state */
            .event-slot.greyed-out {
                background-color: #9ca3af; /* Tailwind gray-400 */
                opacity: 0.5; /* Make it visually distinct */
            }
            .dark .event-slot.greyed-out {
                background-color: #4b5563; /* Tailwind gray-600 */
            }

            /* Panel Specific Styles */
            .controls-panel {
                background-color: var(--panel-bg);
                transition: max-width 0.3s ease-in-out, padding 0.3s ease-in-out, background-color 0.3s, color 0.3s, height 0.3s ease-in-out; /* Added height for mobile collapse */
                overflow: hidden; /* Hide overflowing content during transition */
                flex-shrink: 0; /* Prevent panel from shrinking below its content */
                border-radius: 0.75rem; /* rounded-xl */
                box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            }

            /* Desktop Collapse */
            @media (min-width: 769px) {
                .controls-panel.collapsed {
                    max-width: 50px; /* Adjust this value to control how much it collapses */
                    padding-left: 0.5rem;
                    padding-right: 0.5rem;
                }

                .controls-panel.collapsed .panel-content {
                    display: none; /* Hide the content when collapsed */
                }

                .controls-panel.collapsed .panel-header {
                    justify-content: center; /* Center toggle button when collapsed */
                }

                .controls-panel.collapsed h2 {
                    display: none; /* Hide heading when collapsed */
                }
            }

            /* Mobile Collapse */
            @media (max-width: 768px) {
                .controls-panel.collapsed {
                    height: 50px; /* Collapse height-wise on small screens */
                    padding-top: 0.5rem;
                    padding-bottom: 0.5rem;
                }
                .controls-panel.collapsed .panel-content {
                    display: none;
                }
                .controls-panel.collapsed .panel-header {
                    justify-content: flex-start; /* Revert to start alignment for header */
                }
                .controls-panel.collapsed h2 {
                    display: block; /* Show heading on small screen collapse */
                }
            }

            .controls-panel h2 {
                color: var(--panel-heading-color);
            }

            .controls-panel label {
                color: var(--label-color);
            }

            .controls-panel p.text-xs { /* For secondary text like examples in panels */
                color: var(--secondary-text-color);
            }

            .controls-panel .list-item { /* For high school and college course list items */
                background-color: var(--panel-item-bg);
                border: 1px solid var(--input-border); /* Apply border to items */
                color: var(--main-text-color); /* Text color for list items */
                transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            }
            
            .controls-panel .list-item span.text-sm { /* For secondary text like section counts */
                color: var(--secondary-text-color);
            }

            .controls-panel .section-input-group { /* For college section input groups */
                background-color: var(--panel-item-bg);
                border: 1px dashed var(--input-border); /* Dashed border for section group */
                color: var(--main-text-color); /* Text color for section group */
                transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            }

            .controls-panel .section-input-group h4,
            .controls-panel .section-input-group label {
                color: var(--panel-heading-color); /* Ensure nested titles and labels follow theme */
            }

            .controls-panel input[type="text"],
            .controls-panel input[type="number"] {
                background-color: var(--input-bg);
                color: var(--input-text);
                border-color: var(--input-border);
                transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            }
            /* Style for text inside alert-like messages */
            .text-red-500 {
                color: #ef4444; /* Ensure this remains red */
            }

            /* Adjust Main Content Area to allow schedule to grow */
            .main-content-area {
                display: flex;
                flex-direction: row; /* Default for larger screens */
                width: 100%;
                max-width: 7xl;
                gap: 1.5rem; /* gap-6 */
            }

            .main-content-area > .schedule-panel {
                flex-grow: 1; /* Allow the schedule to take up available space */
                min-width: 50%; /* Ensure schedule doesn't get too small */
            }


            /* Responsive adjustments */
            @media (max-width: 768px) {
                .calendar-grid {
                    grid-template-columns: 60px repeat(5, 1fr);
                }
                .time-column {
                    font-size: 0.75rem; /* text-xs */
                }
                .event-slot {
                    font-size: 0.75rem; /* text-xs */
                    padding: 0.125rem 0.25rem;
                }
                .day-header {
                    font-size: 0.875rem; /* text-sm */
                    padding: 0.5rem 0.25rem;
                }
                /* Adjust layout for small screens */
                .main-content-area {
                    flex-direction: column;
                }
                .schedule-panel {
                    width: 100%;
                }
                /* Ensure panels stack vertically on small screens */
                .controls-panel {
                    width: 100%;
                    max-width: none; /* Remove max-width restriction on small screens */
                    margin-bottom: 1rem; /* Add some space between panels */
                    padding: 1.5rem; /* py-6 px-6 */
                }
                .controls-panel.collapsed {
                    max-width: none; /* No horizontal collapse on small screens */
                    padding: 1rem; /* py-4 px-4 */
                    height: 50px; /* Collapse height-wise on small screens */
                }
                .controls-panel.collapsed .panel-content {
                    display: none;
                }
                .controls-panel.collapsed .panel-header {
                    justify-content: flex-start; /* Revert to start alignment for header */
                }
                .controls-panel.collapsed h2 {
                    display: block; /* Show heading on small screen collapse */
                }
            }
        </style>
    </head>
    <body class="min-h-screen p-4 md:p-8 flex flex-col items-center">
        <div class="flex justify-between items-center w-full max-w-7xl mb-6">
            <h1 id="pageTitle" class="text-3xl md:text-4xl font-bold page-title">Schedules for Algernon ðŸ–±</h1>
            <button id="darkModeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h1M2 12h1m15.325-4.475l.707-.707M3.968 19.032l.707-.707m0-11.314l-.707-.707m11.314 0l.707.707"></path></svg>
                <svg id="moonIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>

        <div class="main-content-area flex flex-col md:flex-row w-full max-w-7xl gap-6">
            <!-- Left Panel for College Courses -->
            <div id="collegePanel" class="controls-panel w-full md:w-1/4 p-6 rounded-xl shadow-xl space-y-6">
                <div class="panel-header flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Add College Course</h2>
                    <button id="collegePanelToggle" class="md:hidden p-1 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div class="panel-content space-y-6">
                    <div>
                        <div class="space-y-4">
                            <div>
                                <label for="collegeCourseNameInput" class="block text-sm font-medium">Course Name:</label>
                                <input type="text" id="collegeCourseNameInput" placeholder="e.g., Calculus II" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="numCollegeSectionsInput" class="block text-sm font-medium">Number of Sections:</label>
                                <input type="number" id="numCollegeSectionsInput" min="1" value="1" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <button id="generateCollegeSectionInputsBtn" class="mt-2 w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:bg-gray-600 dark:text-gray-100 dark:hover:bg-gray-500">Generate Section Inputs</button>
                            </div>
                            <div id="collegeSectionInputsContainer" class="space-y-4 border border-dashed rounded-md p-4 section-input-group">
                                <!-- Dynamic section inputs will go here -->
                            </div>
                            <button id="addCollegeCourseBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">Add College Course</button>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4">My College Courses</h2>
                        <ul id="collegeCoursesList" class="space-y-2">
                            <!-- College courses will be dynamically listed here -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Main Schedule Container -->
            <div id="scheduleContainer" class="schedule-panel w-full md:w-1/2 shadow-xl rounded-xl">
                <div class="calendar-grid min-h-[600px] md:min-h-[700px]">
                    <div class="day-header border-none"></div> <!-- Empty corner -->
                    <div class="day-header">Mon</div>
                    <div class="day-header">Tue</div>
                    <div class="day-header">Wed</div>
                    <div class="day-header">Thu</div>
                    <div class="day-header">Fri</div>

                    <div class="time-column" id="timeColumn">
                        <!-- Time labels will be dynamically generated here -->
                    </div>

                    <div class="schedule-content" id="scheduleContent">
                        <div class="day-column" id="monColumn"></div>
                        <div class="day-column" id="tueColumn"></div>
                        <div class="day-column" id="wedColumn"></div>
                        <div class="day-column" id="thuColumn"></div>
                        <div class="day-column" id="friColumn"></div>
                        <!-- Current time line will be appended here -->
                        <div id="currentTimeLine" class="current-time-line hidden"></div>
                    </div>
                </div>
            </div>

            <!-- Right Panel for High School Courses -->
            <div id="highSchoolPanel" class="controls-panel w-full md:w-1/4 p-6 rounded-xl shadow-xl space-y-6">
                <div class="panel-header flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Add High School Course</h2>
                    <button id="highSchoolPanelToggle" class="md:hidden p-1 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div class="panel-content space-y-6">
                    <div>
                        <div class="space-y-4">
                            <div>
                                <label for="courseNameInput" class="block text-sm font-medium">Course Name:</label>
                                <input type="text" id="courseNameInput" placeholder="e.g., Algebra II" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="periodHoursInput" class="block text-sm font-medium">Hours Offered (comma-separated):</label>
                                <input type="text" id="periodHoursInput" placeholder="e.g., 1st Hour, 4th Hour, Advisory" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Examples: "1st Hour", "Advisory", "5th Hour"</p>
                            </div>
                            <button id="addCourseBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">Add Course</button>
                        </div>
                    </div>

                    <div>
                        <h2 class="text-2xl font-bold mb-4">My High School Courses</h2>
                        <ul id="highSchoolCoursesList" class="space-y-2">
                            <!-- High school courses will be dynamically listed here -->
                        </ul>
                    </div>

                    <!-- Save/Load Section -->
                    <div class="space-y-4 pt-6 border-t border-dashed border-gray-300 dark:border-gray-600">
                        <h2 class="text-2xl font-bold">Manage Schedule</h2>
                        <button id="saveScheduleBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">Save Schedule</button>
                        <input type="file" id="loadFileInput" class="hidden" accept=".txt,application/json">
                        <button id="loadScheduleBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">Load Schedule</button>
                        <button id="autoGenerateBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">Auto Generate Schedule</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal for event details -->
        <div id="eventModal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3 id="modalTitle" class="text-2xl font-bold mb-4"></h3>
                <p class="text-lg mb-2"><span class="font-semibold">Type:</span> <span id="modalType"></span></p>
                <p class="text-lg mb-2"><span class="font-semibold">Day:</span> <span id="modalDays"></span></p>
                <p class="text-lg mb-2"><span class="font-semibold">Time:</span> <span id="modalTime"></span></p>
                <p id="modalPeriod" class="text-lg mb-4 hidden"><span class="font-semibold">Period:</span> <span id="modalPeriodText"></span></p>
                <button id="closeModal" class="mt-4 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md">Close</button>
            </div>
        </div>

        <script>
            // Data Structures for Classes
            class SchoolClass {
                constructor(name, periodHours, color) {
                    this.name = name;
                    this.periodHours = periodHours; // Array of period strings
                    this.color = color;
                    this.type = 'High School Class'; // Explicitly set type for display
                    this.renderableEvents = [];

                    const normalDays = ['Mon', 'Tue', 'Fri'];
                    
                    this.periodHours.forEach(periodHour => {
                        // Add events for normal days (Mon, Tue, Fri)
                        normalDays.forEach(day => {
                            const times = SCHOOL_HOUR_SCHEDULE[day][periodHour];
                            if (times) {
                                this.renderableEvents.push({
                                    name: this.name,
                                    day: day,
                                    startTime: times.start,
                                    endTime: times.end,
                                    color: this.color,
                                    type: this.type,
                                    period: periodHour,
                                    isGreyedOut: false // Default to not greyed out
                                });
                            }
                        });

                        // Add event for block days (Wed, Thu) if applicable
                        // These are predefined in SCHOOL_HOUR_SCHEDULE by period name, 
                        // so we can directly check if the period exists for Wed or Thu
                        if (SCHOOL_HOUR_SCHEDULE['Wed'][periodHour]) {
                            const times = SCHOOL_HOUR_SCHEDULE['Wed'][periodHour];
                            this.renderableEvents.push({
                                name: this.name,
                                day: 'Wed',
                                startTime: times.start,
                                endTime: times.end,
                                color: this.color,
                                type: this.type,
                                period: periodHour,
                                isGreyedOut: false // Default to not greyed out
                            });
                        }
                        if (SCHOOL_HOUR_SCHEDULE['Thu'][periodHour]) {
                            const times = SCHOOL_HOUR_SCHEDULE['Thu'][periodHour];
                            this.renderableEvents.push({
                                name: this.name,
                                day: 'Thu',
                                startTime: times.start,
                                endTime: times.end,
                                color: this.color,
                                type: this.type,
                                period: periodHour,
                                isGreyedOut: false // Default to not greyed out
                            });
                        }
                    });
                }
            }

            class CollegeClass {
                // sections is an array of objects: [{ days: [], startTime: '', endTime: '' }, ...]
                constructor(name, sections, color) {
                    this.name = name;
                    this.sections = sections; // Array of section objects
                    this.color = color;
                    this.type = 'College Class'; // Explicitly set type for display
                    this.renderableEvents = []; // This will hold the actual events to be rendered

                    this.sections.forEach(section => {
                        section.days.forEach(day => {
                            this.renderableEvents.push({
                                name: this.name,
                                day: day,
                                startTime: section.startTime,
                                endTime: section.endTime,
                                color: this.color,
                                type: this.type,
                                period: null, // College classes don't have school periods
                                isGreyedOut: false // Default to not greyed out
                            });
                        });
                    });
                }
            }

            const SCHOOL_HOUR_SCHEDULE = {
                'Mon': {
                    '1st Hour': { start: '07:40', end: '08:32' },
                    '2nd Hour': { start: '08:37', end: '09:29' },
                    '3rd Hour': { start: '09:34', end: '10:26' },
                    '4th Hour': { start: '10:31', end: '11:23' },
                    '5th Hour': { start: '11:23', end: '12:56' }, // Includes lunch overlap example
                    '6th Hour': { start: '13:01', end: '13:53' },
                    '7th Hour': { start: '13:58', end: '14:50' },
                },
                'Tue': {
                    '1st Hour': { start: '07:40', end: '08:32' },
                    '2nd Hour': { start: '08:37', end: '09:29' },
                    '3rd Hour': { start: '09:34', end: '10:26' },
                    '4th Hour': { start: '10:31', end: '11:23' },
                    '5th Hour': { start: '11:23', end: '12:56' }, // Includes lunch overlap example
                    '6th Hour': { start: '13:01', end: '13:53' },
                    '7th Hour': { start: '13:58', end: '14:50' },
                },
                'Wed': {
                    '1st Hour': { start: '07:40', end: '09:13' },
                    'Advisory': { start: '09:20', end: '10:53' },
                    '2nd Hour': { start: '10:53', end: '13:10' }, // Includes lunch overlap example
                    '3rd Hour': { start: '13:17', end: '14:50' },
                },
                'Thu': {
                    '4th Hour': { start: '07:40', end: '09:13' },
                    '5th Hour': { start: '09:20', end: '10:53' },
                    '6th Hour': { start: '10:53', end: '13:10' }, // Includes lunch overlap example
                    '7th Hour': { start: '13:17', end: '14:50' },
                },
                'Fri': {
                    '1st Hour': { start: '07:40', end: '08:32' },
                    '2nd Hour': { start: '08:37', end: '09:29' },
                    '3rd Hour': { start: '09:34', end: '10:26' },
                    '4th Hour': { start: '10:31', end: '11:23' },
                    '5th Hour': { start: '11:23', end: '12:56' }, // Includes lunch overlap example
                    '6th Hour': { start: '13:01', end: '13:53' },
                    '7th Hour': { start: '13:58', end: '14:50' },
                }
            };

            // Pre-process SCHOOL_HOUR_SCHEDULE for easier period block rendering
            const schoolPeriods = {
                'Mon': [], 'Tue': [], 'Wed': [], 'Thu': [], 'Fri': []
            };

            // Populate schoolPeriods with period details from SCHOOL_HOUR_SCHEDULE
            Object.keys(SCHOOL_HOUR_SCHEDULE).forEach(day => {
                for (const periodName in SCHOOL_HOUR_SCHEDULE[day]) {
                    const { start, end } = SCHOOL_HOUR_SCHEDULE[day][periodName];
                    schoolPeriods[day].push({ name: periodName, start, end, label: periodName });
                }
                // Sort periods by start time for correct rendering order
                schoolPeriods[day].sort((a, b) => {
                    const [aHour, aMin] = a.start.split(':').map(Number);
                    const [bHour, bMin] = b.start.split(':').map(Number);
                    if (aHour !== bHour) return aHour - bHour;
                    return aMin - bMin;
                });
            });

            const courses = []; // Array to hold all course objects

            // Available colors for new courses
            const availableColors = [
                'bg-custom-blue', 'bg-custom-green', 'bg-custom-purple', 'bg-custom-yellow',
                'bg-custom-pink', 'bg-custom-teal', 'bg-custom-orange', 'bg-custom-red-500'
            ];
            let colorIndex = 0; // To cycle through colors

            const DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
            const START_HOUR = 7; // Schedule starts at 7 AM
            const END_HOUR = 15; // Schedule ends at 3 PM (15:00)
            const TOTAL_MINUTES_SPAN = (END_HOUR - START_HOUR) * 60; // Total minutes in the visible schedule

            /**
             * Converts a time string (HH:MM) to minutes from the START_HOUR.
             * @param {string} timeStr - The time string (e.g., '08:30').
             * @returns {number} The time in minutes relative to START_HOUR.
             */
            function timeToMinutes(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return (hours - START_HOUR) * 60 + minutes;
            }

            /**
             * Formats minutes (relative to START_HOUR) into a user-friendly time string (HH:MM AM/PM).
             * @param {number} minutes - The minutes from START_HOUR.
             * @returns {string} The formatted time string.
             */
            function formatMinutesToTime(minutes) {
                const totalMinutes = START_HOUR * 60 + minutes;
                const hours = Math.floor(totalMinutes / 60);
                const mins = totalMinutes % 60;
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 === 0 ? 12 : hours % 12;
                return `${displayHours}:${mins.toString().padStart(2, '0')} ${ampm}`;
            }

            /**
             * Renders the dashed period blocks on the schedule grid.
             * These blocks visually represent the standard school period times.
             */
            function renderPeriodBlocks() {
                DAYS.forEach(day => {
                    const dayColumn = document.getElementById(`${day.toLowerCase()}Column`);
                    if (dayColumn) {
                        // Clear existing period blocks to prevent duplicates on re-render
                        dayColumn.querySelectorAll('.period-block').forEach(block => block.remove());

                        schoolPeriods[day].forEach(period => {
                            const startMinutes = timeToMinutes(period.start);
                            const endMinutes = timeToMinutes(period.end);
                            const durationMinutes = endMinutes - startMinutes;

                            const topPercentage = (startMinutes / TOTAL_MINUTES_SPAN) * 100;
                            const heightPercentage = (durationMinutes / TOTAL_MINUTES_SPAN) * 100;

                            const periodBlock = document.createElement('div');
                            periodBlock.className = 'period-block';
                            periodBlock.style.top = `${topPercentage}%`;
                            periodBlock.style.height = `${heightPercentage}%`;
                            // Conditional rendering of the period label: only for "Advisory"
                            periodBlock.innerHTML = `${period.label === 'Advisory' ? `<span class="opacity-50">${period.label}</span>` : ''}`;
                            dayColumn.appendChild(periodBlock);
                        });
                    }
                });
            }

            /**
             * Renders the time labels along the left side of the schedule grid.
             */
            function renderTimeLabels() { // Renamed from renderTimeColumn
                const timeColumn = document.getElementById('timeColumn');
                if (!timeColumn) return;

                // Clear existing time labels
                timeColumn.innerHTML = '';

                for (let i = START_HOUR; i <= END_HOUR; i++) {
                    const hourInMinutes = (i - START_HOUR) * 60;
                    const topPercentage = (hourInMinutes / TOTAL_MINUTES_SPAN) * 100;

                    const timeLabelDiv = document.createElement('div');
                    timeLabelDiv.className = 'time-label';
                    timeLabelDiv.style.top = `${topPercentage}%`; // Position at the start of the hour
                    
                    const displayHour = i % 12 === 0 ? 12 : i % 12;
                    const ampm = i < 12 ? 'AM' : 'PM';
                    timeLabelDiv.textContent = `${displayHour}:${'00'} ${ampm}`; // Ensure minutes are '00'
                    
                    timeColumn.appendChild(timeLabelDiv);
                }
            }

            /**
             * Toggles the color of an event element between its original color and a greyed-out state.
             * @param {HTMLElement} eventElement - The event slot DOM element to toggle.
             * @param {object} eventData - The corresponding event data object from the courses array.
             */
            function toggleEventColor(eventElement, eventData) {
                const originalColor = eventData.color; // Use original color from eventData
                eventData.isGreyedOut = !eventData.isGreyedOut; // Toggle the state in the data

                if (eventData.isGreyedOut) {
                    eventElement.classList.remove(originalColor);
                    eventElement.classList.add('greyed-out');
                } else {
                    eventElement.classList.remove('greyed-out');
                    eventElement.classList.add(originalColor);
                }
            }


            /**
             * Renders all scheduled events (high school and college classes) onto the schedule grid.
             * It clears existing events and re-renders them based on the 'courses' array.
             */
            function renderCourses() { // Renamed from renderEvents
                // Clear existing events from all day columns
                DAYS.forEach(day => {
                    const dayColumn = document.getElementById(`${day.toLowerCase()}Column`);
                    if (dayColumn) {
                        dayColumn.querySelectorAll('.event-slot').forEach(eventEl => eventEl.remove());
                    }
                });

                // Iterate through all courses and their renderable events
                const allRenderableEvents = [];
                courses.forEach(course => {
                    allRenderableEvents.push(...course.renderableEvents);
                });

                // Group events by day and create initial DOM elements (default to full width)
                const eventsByDay = {};
                DAYS.forEach(day => eventsByDay[day] = []);
                allRenderableEvents.forEach(eventData => {
                    const dayColumn = document.getElementById(`${eventData.day.toLowerCase()}Column`);
                    if (!dayColumn) return;

                    const startMinutes = timeToMinutes(eventData.startTime);
                    const endMinutes = timeToMinutes(eventData.endTime);
                    const durationMinutes = endMinutes - startMinutes;

                    const topPercentage = (startMinutes / TOTAL_MINUTES_SPAN) * 100;
                    const heightPercentage = (durationMinutes / TOTAL_MINUTES_SPAN) * 100;

                    const eventSlot = document.createElement('div');
                    // Apply original color or greyed-out class based on eventData.isGreyedOut
                    eventSlot.className = `event-slot ${eventData.isGreyedOut ? 'greyed-out' : eventData.color} flex flex-col items-center justify-center text-center p-1`;
                    
                    // Store original color for toggling back
                    eventSlot.dataset.originalColor = eventData.color;

                    eventSlot.style.top = `${topPercentage}%`;
                    eventSlot.style.height = `${heightPercentage}%`;
                    eventSlot.title = `${eventData.name} (${eventData.startTime} - ${eventData.endTime})`; // Tooltip

                    // Event content - name and time range
                    const eventName = document.createElement('div');
                    eventName.className = 'font-semibold truncate';
                    eventName.textContent = eventData.name;
                    eventSlot.appendChild(eventName);

                    const eventTime = document.createElement('div');
                    eventTime.className = 'text-xs opacity-90 truncate';
                    eventTime.textContent = `${formatMinutesToTime(startMinutes)} - ${formatMinutesToTime(endMinutes)}`;
                    eventSlot.appendChild(eventTime);
                    
                    // Store event data for modal (still available if modal is triggered differently)
                    eventSlot.dataset.name = eventData.name;
                    eventSlot.dataset.type = eventData.type;
                    eventSlot.dataset.day = eventData.day;
                    eventSlot.dataset.startTime = eventData.startTime;
                    eventSlot.dataset.endTime = eventData.endTime;
                    eventSlot.dataset.period = eventData.period || ''; // Use empty string if no period
                    // No need to store isGreyedOut in dataset as it's directly updated in eventData object

                    // Attach click listener for toggling color, passing both element and data
                    eventSlot.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent clicks on parent elements if any
                        toggleEventColor(eventSlot, eventData);
                    });
                    
                    // Store the DOM element reference on the eventData object
                    eventData.element = eventSlot;
                    dayColumn.appendChild(eventSlot); // Append now, then re-position
                    eventsByDay[eventData.day].push(eventData);
                });

                // Process each day to apply column packing only for overlapping groups
                DAYS.forEach(day => {
                    const dayEvents = eventsByDay[day];
                    if (dayEvents.length === 0) return;

                    // Sort events by start time for consistent processing
                    dayEvents.sort((a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime));

                    const processedEventDataSet = new Set(); // Use a Set to track processed eventData objects

                    dayEvents.forEach(eventData => {
                        if (processedEventDataSet.has(eventData)) {
                            return; // Already processed as part of a previous overlap group
                        }

                        const currentOverlapGroup = [];
                        const queue = [eventData]; // Use a queue for BFS-like traversal to find connected component
                        processedEventDataSet.add(eventData);

                        let head = 0;
                        while (head < queue.length) {
                            const refEvent = queue[head];
                            currentOverlapGroup.push(refEvent); // Add to the actual group

                            const refStart = timeToMinutes(refEvent.startTime);
                            const refEnd = timeToMinutes(refEvent.endTime);

                            dayEvents.forEach(potentialOverlapEvent => {
                                if (!processedEventDataSet.has(potentialOverlapEvent)) {
                                    const poeStart = timeToMinutes(potentialOverlapEvent.startTime);
                                    const poeEnd = timeToMinutes(potentialOverlapEvent.endTime);

                                    // Check for overlap between refEvent and potentialOverlapEvent
                                    if (refStart < poeEnd && refEnd > poeStart) {
                                        processedEventDataSet.add(potentialOverlapEvent);
                                        queue.push(potentialOverlapEvent); // Add to queue to process its overlaps later
                                    }
                                }
                            });
                            head++;
                        }

                        // At this point, currentOverlapGroup contains a maximal set of transitively overlapping events.
                        // Now, apply column packing only within this group.
                        if (currentOverlapGroup.length > 1) { // Only adjust if there's an actual overlap (more than one event)
                            const groupColumns = []; // Stores lastEndTime for each lane in this group

                            // Sort within the group for lane assignment (important for greedy packing)
                            currentOverlapGroup.sort((a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime));

                            currentOverlapGroup.forEach(groupEvent => {
                                const groupEventStartMinutes = timeToMinutes(groupEvent.startTime);
                                const groupEventEndMinutes = timeToMinutes(groupEvent.endTime);

                                let assignedLane = -1;
                                // Find the first lane where this event can fit
                                for (let i = 0; i < groupColumns.length; i++) {
                                    if (groupEventStartMinutes >= groupColumns[i]) {
                                        assignedLane = i;
                                        groupColumns[i] = groupEventEndMinutes; // Update lane's end time
                                        break;
                                    }
                                }

                                if (assignedLane === -1) {
                                    // No suitable lane found, create a new one
                                    assignedLane = groupColumns.length;
                                    groupColumns.push(groupEventEndMinutes);
                                }
                                groupEvent.visualLane = assignedLane; // Store the local lane for this group
                            });

                            const maxLanesInGroup = groupColumns.length;
                            const columnWidthInGroup = 100 / maxLanesInGroup;

                            currentOverlapGroup.forEach(groupEvent => {
                                // Update the actual DOM element's style
                                groupEvent.element.style.width = `${columnWidthInGroup}%`;
                                groupEvent.element.style.left = `${groupEvent.visualLane * columnWidthInGroup}%`;
                            });
                        }
                        // If currentOverlapGroup.length is 1, it means the event didn't overlap with anything,
                        // so its default 100% width and 0% left (set initially) will remain.
                    });
                });
            }

            /**
             * Updates the position of the current time line on the schedule.
             * The line is visible only within the schedule's active hours.
             */
            function updateCurrentTimeLine() {
                const currentTimeLine = document.getElementById('currentTimeLine');
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const currentDay = now.toLocaleDateString('en-US', { weekday: 'short' });

                // Only show the line for Mon-Fri during schedule hours
                const isWeekday = DAYS.includes(currentDay);
                const isDuringHours = currentHour >= START_HOUR && currentHour <= END_HOUR;

                if (isWeekday && isDuringHours) {
                    currentTimeLine.classList.remove('hidden');
                    
                    // Calculate position relative to START_HOUR
                    const minutesSinceStart = (currentHour - START_HOUR) * 60 + currentMinute;
                    const topPercentage = (minutesSinceStart / TOTAL_MINUTES_SPAN) * 100;

                    currentTimeLine.style.top = `${topPercentage}%`;

                    // Position the line correctly over the current day's column
                    const dayIndex = DAYS.indexOf(currentDay);
                    if (dayIndex !== -1) {
                        // The schedule content grid has 5 columns (index 0-4 for Mon-Fri)
                        // The currentTimeLine is absolute positioned within the schedule-content which itself is grid-column 2 / span 5.
                        // So its left should be 0, and its width should span across the entire schedule-content.
                        currentTimeLine.style.left = '0';
                        currentTimeLine.style.right = '0'; // Span full width of schedule-content
                        currentTimeLine.style.gridColumn = `${dayIndex + 1}`; // Align within the schedule-content's grid
                    } else {
                        currentTimeLine.classList.add('hidden');
                    }
                } else {
                    currentTimeLine.classList.add('hidden');
                }
            }

            const eventModal = document.getElementById('eventModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalType = document.getElementById('modalType');
            const modalDays = document.getElementById('modalDays');
            const modalTime = document.getElementById('modalTime');
            const modalPeriod = document.getElementById('modalPeriod');
            const modalPeriodText = document.getElementById('modalPeriodText');
            const closeModalBtn = document.getElementById('closeModal');

            function showEventModal(eventDetails) {
                modalTitle.textContent = eventDetails.name;
                modalType.textContent = eventDetails.type;
                modalDays.textContent = eventDetails.day;
                modalTime.textContent = `${eventDetails.startTime} - ${eventDetails.endTime}`;

                if (eventDetails.type === 'High School Class' && eventDetails.period) { // Changed 'School Class' to 'High School Class' for consistency
                    modalPeriod.classList.remove('hidden');
                    modalPeriodText.textContent = eventDetails.period;
                } else {
                    modalPeriod.classList.add('hidden');
                }

                eventModal.classList.remove('hidden');
            }

            closeModalBtn.addEventListener('click', () => {
                eventModal.classList.add('hidden');
            });

            eventModal.addEventListener('click', (e) => {
                if (e.target === eventModal) {
                    eventModal.classList.add('hidden');
                }
            });

            const darkModeToggle = document.getElementById('darkModeToggle');
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                }
            }

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }

            darkModeToggle.addEventListener('click', () => {
                if (document.documentElement.classList.contains('dark')) {
                    applyTheme('light');
                    localStorage.setItem('theme', 'light');
                } else {
                    applyTheme('dark');
                    localStorage.setItem('theme', 'dark'); // Corrected from localStorage.setItem('dark');
                }
            });

            // Panel Collapse/Expand Logic (for mobile)
            function setupPanelToggle(panelId, toggleId) {
                const panel = document.getElementById(panelId);
                const toggleButton = document.getElementById(toggleId);
                const panelContent = panel.querySelector('.panel-content');
                const heading = panel.querySelector('h2');

                const updatePanelState = () => {
                    const isCollapsed = panel.classList.contains('collapsed');
                    const isMobile = window.innerWidth <= 768;

                    if (isMobile) {
                        // Mobile: collapse vertically
                        heading.style.display = 'block'; // Always show heading on mobile
                        if (isCollapsed) {
                            panelContent.style.display = 'none';
                            toggleButton.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>'; // Arrow down
                        } else {
                            panelContent.style.display = 'block';
                            toggleButton.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>'; // Arrow up
                        }
                    } else {
                        // Desktop: collapse horizontally
                        if (isCollapsed) {
                            heading.style.display = 'none';
                            panelContent.style.display = 'none';
                            toggleButton.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>'; // Arrow right
                        } else {
                            heading.style.display = 'block';
                            panelContent.style.display = 'block';
                            toggleButton.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>'; // Arrow left
                        }
                    }
                };

                // Initial state setup
                updatePanelState();

                // Event listener for toggle button
                toggleButton.addEventListener('click', () => {
                    panel.classList.toggle('collapsed');
                    updatePanelState();
                });

                // Update on window resize
                window.addEventListener('resize', updatePanelState);
            }

            setupPanelToggle('collegePanel', 'collegePanelToggle');
            setupPanelToggle('highSchoolPanel', 'highSchoolPanelToggle');

            // --- High School Course Management ---

            const hsCourseNameInput = document.getElementById('courseNameInput');
            const hsPeriodHoursInput = document.getElementById('periodHoursInput');
            const hsAddCourseBtn = document.getElementById('addCourseBtn');
            const highSchoolCoursesList = document.getElementById('highSchoolCoursesList');

            // Utility to parse user input for period hours for high school classes
            function parseHighSchoolPeriodHoursInput(inputString) {
                const periodMap = {
                    '1': '1st Hour', '1st': '1st Hour', '1st hour': '1st Hour',
                    '2': '2nd Hour', '2nd': '2nd Hour', '2nd hour': '2nd Hour',
                    '3': '3rd Hour', '3rd': '3rd Hour', '3rd hour': '3rd Hour',
                    '4': '4th Hour', '4th': '4th Hour', '4th hour': '4th Hour',
                    '5': '5th Hour', '5th': '5th Hour', '5th hour': '5th Hour',
                    '6': '6th Hour', '6th': '6th Hour', '6th hour': '6th Hour',
                    '7': '7th Hour', '7th': '7th Hour', '7th hour': '7th Hour',
                    'advisory': 'Advisory', 'Advisory': 'Advisory'
                };
                return inputString.split(',')
                                .map(s => s.trim())
                                .filter(s => s !== '')
                                .map(s => periodMap[s.toLowerCase()] || s);
            }

            function renderHighSchoolCoursesList() {
                highSchoolCoursesList.innerHTML = '';

                courses.forEach((course, index) => {
                    if (course.type === 'High School Class') { // Changed 'School Class' to 'High School Class'
                        const listItem = document.createElement('li');
                        listItem.className = 'flex justify-between items-center p-3 rounded-md shadow-sm list-item';
                        
                        listItem.innerHTML = `
                            <span class="font-medium">${course.name}</span>
                            <button data-index="${index}" class="remove-btn bg-red-500 hover:bg-red-600 text-white text-sm font-semibold py-1 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">Remove</button>
                        `;
                        highSchoolCoursesList.appendChild(listItem);
                    }
                });

                document.querySelectorAll('#highSchoolCoursesList .remove-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const indexToRemove = parseInt(event.target.dataset.index);
                        removeCourse(indexToRemove);
                    });
                });
            }

            hsAddCourseBtn.addEventListener('click', () => {
                const name = hsCourseNameInput.value.trim();
                const periodHoursString = hsPeriodHoursInput.value.trim();

                if (!name || !periodHoursString) {
                    alert('Please enter both course name and hours offered for high school class.');
                    return;
                }

                const periodHours = parseHighSchoolPeriodHoursInput(periodHoursString);
                const hasValidPeriod = periodHours.some(ph => {
                    return Object.values(SCHOOL_HOUR_SCHEDULE).some(daySchedule => daySchedule[ph]);
                });

                if (!hasValidPeriod) {
                    alert('Please enter valid period hours (e.g., "1st Hour", "Advisory", "4th Hour") for high school class.');
                    return;
                }

                const newColor = availableColors[colorIndex % availableColors.length];
                colorIndex++;

                const newCourse = new SchoolClass(name, periodHours, newColor);
                courses.push(newCourse);

                hsCourseNameInput.value = '';
                hsPeriodHoursInput.value = '';

                renderCourses();
                renderHighSchoolCoursesList();
            });

            // --- College Course Management ---

            const collegeCourseNameInput = document.getElementById('collegeCourseNameInput');
            const numCollegeSectionsInput = document.getElementById('numCollegeSectionsInput');
            const generateCollegeSectionInputsBtn = document.getElementById('generateCollegeSectionInputsBtn');
            const collegeSectionInputsContainer = document.getElementById('collegeSectionInputsContainer');
            const addCollegeCourseBtn = document.getElementById('addCollegeCourseBtn');
            const collegeCoursesList = document.getElementById('collegeCoursesList');

            // Dynamically generate input fields for college sections
            function generateCollegeSectionInputs() {
                collegeSectionInputsContainer.innerHTML = ''; // Clear previous inputs
                const numSections = parseInt(numCollegeSectionsInput.value);

                if (isNaN(numSections) || numSections <= 0) {
                    collegeSectionInputsContainer.innerHTML = '<p class="text-sm text-red-500">Please enter a valid number of sections (1 or more).</p>';
                    return;
                }

                for (let i = 0; i < numSections; i++) {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'section-input-group border border-dashed rounded-md p-3 space-y-2';
                    sectionDiv.innerHTML = `
                        <h4 class="font-semibold">Section ${i + 1}</h4>
                        <div>
                            <label class="block text-sm font-medium">Days (comma-separated: Mon, Tue, Wed, Thu, Fri):</label>
                            <input type="text" class="section-days-input mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., Mon, Wed, Fri">
                        </div>
                        <div class="flex gap-2">
                            <div class="w-1/2">
                                <label class="block text-sm font-medium">Start Time (HH:MM):</label>
                                <input type="text" class="section-start-time-input mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., 09:00">
                            </div>
                            <div class="w-1/2">
                                <label class="block text-sm font-medium">End Time (HH:MM):</label>
                                <input type="text" class="section-end-time-input mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., 10:15">
                            </div>
                        </div>
                    `;
                    collegeSectionInputsContainer.appendChild(sectionDiv);
                }
            }

            // Validate time format (HH:MM)
            function isValidTime(timeStr) {
                const regex = /^(?:2[0-3]|[01]?[0-9]):(?:[0-5]?[0-9])$/;
                return regex.test(timeStr);
            }

            // Add College Course button click handler
            addCollegeCourseBtn.addEventListener('click', () => {
                const name = collegeCourseNameInput.value.trim();
                if (!name) {
                    alert('Please enter a college course name.');
                    return;
                }

                const sections = [];
                let isValid = true;
                const sectionInputGroups = collegeSectionInputsContainer.querySelectorAll('.section-input-group');

                if (sectionInputGroups.length === 0) {
                    alert('Please generate and fill in at least one section for the college course.');
                    return;
                }

                sectionInputGroups.forEach(group => {
                    const daysInput = group.querySelector('.section-days-input').value.trim();
                    const startTimeInput = group.querySelector('.section-start-time-input').value.trim();
                    const endTimeInput = group.querySelector('.section-end-time-input').value.trim();

                    // Normalize input days to match the case in the DAYS array ('Mon', 'Tue', etc.)
                    const originalDaysArray = daysInput.split(',').map(d => d.trim()).filter(d => d !== '');
                    const parsedDays = originalDaysArray
                                        .map(d => d.charAt(0).toUpperCase() + d.slice(1).toLowerCase())
                                        .filter(d => DAYS.includes(d));

                    if (parsedDays.length !== originalDaysArray.length || !isValidTime(startTimeInput) || !isValidTime(endTimeInput)) {
                        alert('Please ensure all section fields are filled correctly, days are valid (Mon, Tue, etc.), and times are in HH:MM format (e.g., 09:00).');
                        isValid = false;
                        return;
                    }

                    // Additional time validation: end time must be after start time
                    const startMinutes = timeToMinutes(startTimeInput);
                    const endMinutes = timeToMinutes(endTimeInput);
                    if (endMinutes <= startMinutes) {
                        alert('End time must be after start time for all sections.');
                        isValid = false;
                        return;
                    }
                    
                    sections.push({ days: parsedDays, startTime: startTimeInput, endTime: endTimeInput });
                });

                if (!isValid) return; // Stop if any section input was invalid

                const newColor = availableColors[colorIndex % availableColors.length];
                colorIndex++;

                const newCourse = new CollegeClass(name, sections, newColor);
                courses.push(newCourse);

                collegeCourseNameInput.value = '';
                numCollegeSectionsInput.value = '1'; // Reset to 1 section
                collegeSectionInputsContainer.innerHTML = ''; // Clear generated sections

                renderCourses();
                renderHighSchoolCoursesList(); // Re-render HS list in case indices changed
                renderCollegeCoursesList();
            });

            // Generate section inputs when number of sections changes
            generateCollegeSectionInputsBtn.addEventListener('click', generateCollegeSectionInputs);


            function renderCollegeCoursesList() {
                collegeCoursesList.innerHTML = ''; // Clear existing list

                courses.forEach((course, index) => {
                    if (course.type === 'College Class') {
                        const listItem = document.createElement('li');
                        listItem.className = 'flex justify-between items-center p-3 rounded-md shadow-sm list-item';
                        
                        // Display only the course name and number of sections
                        const numSections = course.sections.length;
                        listItem.innerHTML = `
                            <span class="font-medium">${course.name} <span class="text-sm">(${numSections} section${numSections === 1 ? '' : 's'})</span></span>
                            <button data-index="${index}" class="remove-btn bg-red-500 hover:bg-red-600 text-white text-sm font-semibold py-1 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">Remove</button>
                        `;
                        collegeCoursesList.appendChild(listItem);
                    }
                });

                document.querySelectorAll('#collegeCoursesList .remove-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const indexToRemove = parseInt(event.target.dataset.index);
                        removeCourse(indexToRemove);
                    });
                });
            }

            // Generic remove course function (removes from main courses array and re-renders)
            function removeCourse(index) {
                courses.splice(index, 1);
                renderCourses();
                renderHighSchoolCoursesList(); // Re-render both lists to update indices and content
                renderCollegeCoursesList();
            }

            // --- Save and Load Functionality ---
            const saveScheduleBtn = document.getElementById('saveScheduleBtn');
            const loadScheduleBtn = document.getElementById('loadScheduleBtn');
            const loadFileInput = document.getElementById('loadFileInput');

            saveScheduleBtn.addEventListener('click', () => {
                const scheduleData = JSON.stringify(courses, null, 2); // Pretty print JSON
                const blob = new Blob([scheduleData], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'algernon_schedule.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            loadScheduleBtn.addEventListener('click', () => {
                loadFileInput.click(); // Trigger the hidden file input click
            });

            loadFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        if (Array.isArray(loadedData)) {
                            // Clear existing courses
                            courses.length = 0; 
                            // Re-populate courses array with loaded data
                            loadedData.forEach(loadedCourse => {
                                // Ensure loaded data conforms to class structure
                                if (loadedCourse.type === 'High School Class') {
                                    const newHsCourse = new SchoolClass(loadedCourse.name, loadedCourse.periodHours, loadedCourse.color);
                                    newHsCourse.renderableEvents = loadedCourse.renderableEvents.map(event => ({
                                        ...event,
                                        isGreyedOut: event.isGreyedOut || false // Ensure isGreyedOut is present
                                    }));
                                    courses.push(newHsCourse);
                                } else if (loadedCourse.type === 'College Class') {
                                    const newCollegeCourse = new CollegeClass(loadedCourse.name, loadedCourse.sections, loadedCourse.color);
                                     newCollegeCourse.renderableEvents = loadedCourse.renderableEvents.map(event => ({
                                        ...event,
                                        isGreyedOut: event.isGreyedOut || false // Ensure isGreyedOut is present
                                    }));
                                    courses.push(newCollegeCourse);
                                }
                            });
                            
                            // Re-render everything
                            renderCourses();
                            renderHighSchoolCoursesList();
                            renderCollegeCoursesList();
                            alert('Schedule loaded successfully!');
                        } else {
                            alert('Invalid file format. Please select a valid schedule file.');
                        }
                    } catch (error) {
                        console.error('Error parsing schedule file:', error);
                        alert('Error loading schedule. Please ensure the file is a valid JSON format.');
                    }
                };
                reader.readAsText(file);
            });


            // Auto Generate Schedule Button
            document.getElementById('autoGenerateBtn').addEventListener('click', () => {
                alert('ðŸš§ Auto Schedule Generation is under construction! ðŸš§');
            });

            // Initial rendering and updates
            window.addEventListener('load', () => {
                renderTimeLabels(); // Corrected function name
                renderPeriodBlocks();
                renderCourses(); // Corrected function name
                renderHighSchoolCoursesList();
                renderCollegeCoursesList(); // Render college courses list on load
                generateCollegeSectionInputs(); // Generate initial section inputs
                updateCurrentTimeLine();
                setInterval(updateCurrentTimeLine, 60 * 1000);
            });

            window.addEventListener('resize', () => {
                // Clear current events and re-render for responsive layout adjustment
                DAYS.forEach(day => {
                    const dayColumn = document.getElementById(`${day.toLowerCase()}Column`);
                    dayColumn.innerHTML = '';
                });
                renderPeriodBlocks(); // Re-render static period blocks
                renderCourses(); // Re-render dynamic courses with updated layout

                updateCurrentTimeLine();
                // Removed the problematic panel resize logic here, as setupPanelToggle already handles it.
            });

        </script>
        <script src="./autoGenerateSchedule.js"></script>
        <script src="./scheduleGenerator.js"></script>
        sc
    </body>
    </html>
